<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>ECharts Candle Local</title>
  <script src="https://cdn.jsdelivr.net/npm/echarts@5"></script>
  <style>
    html, body { height: 100%; margin: 0; }
    #main { width: 100%; height: 100vh; }
  </style>
</head>
<body>

<div id="main"></div>

<script type="module">
import * as echarts from "https://cdn.jsdelivr.net/npm/echarts@5.5.0/dist/echarts.esm.min.js";

var chartDom = document.getElementById('main');
var myChart = echarts.init(chartDom);
var option;

const upColor = '#00da3c';
const downColor = '#ec0000';

const rawData = [
  ["2015-01-02", 17823.07, 17832.99, 17731.92, 17923.23, 347300000],
  ["2015-01-05", 17832.99, 17731.92, 17600.01, 17923.23, 347300000],
  ["2015-01-06", 17729.21, 17371.64, 17262.75, 17729.21, 476600000],
  ["2015-01-07", 17378.08, 17584.52, 17378.08, 17630.11, 363800000],
  ["2015-01-08", 17589.73, 17907.87, 17589.73, 17908.17, 377700000],
  ["2015-01-09", 17909.07, 17737.37, 17697.62, 17917.66, 389500000],
  ["2015-01-12", 17735.05, 17640.84, 17573.51, 17812.09, 342400000],
  ["2015-01-13", 17641.72, 17613.68, 17573.51, 17782.13, 396300000],
  ["2015-01-14", 17610.22, 17427.09, 17375.48, 17610.22, 410700000],
  ["2015-01-15", 17431.85, 17320.71, 17290.15, 17500.51, 391000000],
  ["2015-01-16", 17323.82, 17511.57, 17323.82, 17524.95, 377200000],
  ["2015-01-20", 17510.92, 17515.23, 17472.48, 17612.18, 362000000],
  ["2015-01-21", 17515.23, 17554.28, 17472.48, 17612.18, 342000000],
  ["2015-01-22", 17550.23, 17813.98, 17550.23, 17820.15, 356000000],
  ["2015-01-23", 17813.98, 17672.60, 17650.20, 17835.00, 348000000],
  ["2015-01-26", 17673.12, 17678.70, 17550.00, 17780.22, 314000000],
  ["2015-01-27", 17678.70, 17387.21, 17350.00, 17700.00, 382000000],
  ["2015-01-28", 17387.21, 17191.37, 17100.00, 17450.00, 421000000],
  ["2015-01-29", 17191.37, 17416.85, 17191.37, 17450.00, 403000000],
  ["2015-01-30", 17416.85, 17164.95, 17100.00, 17420.00, 423000000],
  ["2015-02-02", 17164.95, 17361.04, 17100.00, 17400.00, 382000000],
  ["2015-02-03", 17361.04, 17666.40, 17361.04, 17700.00, 369000000],
  ["2015-02-04", 17666.40, 17673.02, 17600.00, 17750.00, 343000000],
  ["2015-02-05", 17673.02, 17884.88, 17650.00, 17900.00, 356000000],
  ["2015-02-06", 17884.88, 17824.29, 17780.00, 17950.00, 317000000],
  ["2015-02-09", 17824.29, 17729.21, 17700.00, 17880.00, 293000000],
  ["2015-02-10", 17729.21, 17868.76, 17729.21, 17900.00, 276000000],
  ["2015-02-11", 17868.76, 17862.14, 17800.00, 17900.00, 273000000],
  ["2015-02-12", 17862.14, 17972.38, 17850.00, 18000.00, 280000000],
  ["2015-02-13", 17972.38, 18019.35, 17950.00, 18050.00, 274000000],
  ["2015-02-17", 18019.35, 18047.58, 18000.00, 18070.00, 270000000],
  ["2015-02-18", 18047.58, 18029.85, 18000.00, 18080.00, 260000000],
  ["2015-02-19", 18029.85, 17985.77, 17950.00, 18070.00, 280000000],
  ["2015-02-20", 17985.77, 18140.44, 17985.77, 18150.00, 292000000],
  ["2015-02-23", 18140.44, 18116.84, 18100.00, 18180.00, 280000000],
  ["2015-02-24", 18116.84, 18209.19, 18100.00, 18220.00, 290000000],
  ["2015-02-25", 18209.19, 18224.57, 18180.00, 18250.00, 310000000],
  ["2015-02-26", 18224.57, 18214.42, 18200.00, 18250.00, 280000000],
  ["2015-02-27", 18214.42, 18132.70, 18100.00, 18250.00, 290000000],
  ["2015-03-02", 18132.70, 18288.63, 18132.70, 18300.00, 315000000],
  ["2015-03-03", 18288.63, 18203.37, 18200.00, 18300.00, 296000000],
  ["2015-03-04", 18203.37, 18096.90, 18000.00, 18250.00, 310000000],
  ["2015-03-05", 18096.90, 18135.72, 18000.00, 18200.00, 290000000],
  ["2015-03-06", 18135.72, 17856.78, 17800.00, 18150.00, 340000000],
  ["2015-03-09", 17856.78, 17995.72, 17850.00, 18000.00, 305000000],
  ["2015-03-10", 17995.72, 17662.94, 17650.00, 18000.00, 342000000],
  ["2015-03-11", 17662.94, 17635.39, 17600.00, 17750.00, 302000000],
  ["2015-03-12", 17635.39, 17895.22, 17635.39, 17900.00, 292000000],
  ["2015-03-13", 17895.22, 17749.31, 17700.00, 17900.00, 325000000],
  ["2015-03-16", 17749.31, 17977.42, 17749.31, 18000.00, 288000000],
  ["2015-03-17", 17977.42, 17949.31, 17900.00, 18000.00, 276000000],
  ["2015-03-18", 17949.31, 18076.19, 17900.00, 18100.00, 325000000],
  ["2015-03-19", 18076.19, 17959.03, 17900.00, 18100.00, 295000000],
  ["2015-03-20", 17959.03, 18127.65, 17959.03, 18150.00, 410000000]
];

function splitData(rawData) {
  let categoryData = [];
  let values = [];
  let volumes = [];
  for (let i = 0; i < rawData.length; i++) {
    categoryData.push(rawData[i][0]); // date
    values.push([rawData[i][1], rawData[i][2], rawData[i][3], rawData[i][4]]); // OHLC
    volumes.push([i, rawData[i][5], rawData[i][1] > rawData[i][2] ? 1 : -1]); // volume
  }
  return { categoryData, values, volumes };
}

function calculateMA(dayCount, data) {
  let result = [];
  for (let i = 0; i < data.values.length; i++) {
    if (i < dayCount) {
      result.push('-');
      continue;
    }
    let sum = 0;
    for (let j = 0; j < dayCount; j++) {
      sum += data.values[i - j][1];
    }
    result.push((sum / dayCount).toFixed(2));
  }
  return result;
}

const data = splitData(rawData);

option = {
  animation: false,
  legend: {
    bottom: 10,
    left: 'center',
    data: ['DJI', 'MA5', 'MA10', 'MA20', 'MA30']
  },
  tooltip: {
    trigger: 'axis',
    axisPointer: { type: 'cross' }
  },
  axisPointer: { link: [{ xAxisIndex: 'all' }] },
  toolbox: {
    feature: {
      dataZoom: { yAxisIndex: false },
      brush: { type: ['lineX', 'clear'] }
    }
  },
  brush: { xAxisIndex: 'all', brushLink: 'all' },
  visualMap: {
    show: false,
    seriesIndex: 5,
    dimension: 2,
    pieces: [
      { value: 1, color: downColor },
      { value: -1, color: upColor }
    ]
  },
  grid: [
    { left: '10%', right: '8%', height: '50%' },
    { left: '10%', right: '8%', top: '63%', height: '16%' }
  ],
  xAxis: [
    {
      type: 'category',
      data: data.categoryData,
      boundaryGap: false,
      min: 'dataMin',
      max: 'dataMax'
    },
    {
      type: 'category',
      gridIndex: 1,
      data: data.categoryData,
      boundaryGap: false,
      axisTick: { show: false },
      axisLabel: { show: false },
      min: 'dataMin',
      max: 'dataMax'
    }
  ],
  yAxis: [{ scale: true }, { scale: true, gridIndex: 1 }],
  dataZoom: [
    { type: 'inside', xAxisIndex: [0, 1], start: 70, end: 100 },
    { show: true, xAxisIndex: [0, 1], type: 'slider', top: '85%', start: 70, end: 100 }
  ],
  series: [
    { name: 'DJI', type: 'candlestick', data: data.values },
    { name: 'MA5',  type: 'line', data: calculateMA(5, data),  smooth: true },
    { name: 'MA10', type: 'line', data: calculateMA(10, data), smooth: true },
    { name: 'MA20', type: 'line', data: calculateMA(20, data), smooth: true },
    { name: 'MA30', type: 'line', data: calculateMA(30, data), smooth: true },
    { name: 'Volume', type: 'bar', xAxisIndex: 1, yAxisIndex: 1, data: data.volumes }
  ]
};

myChart.setOption(option);

// ✅ 반응형 자동 리사이즈
window.addEventListener('resize', () => myChart.resize());
new ResizeObserver(() => myChart.resize()).observe(document.querySelector("#main"));
</script>

</body>
</html>
